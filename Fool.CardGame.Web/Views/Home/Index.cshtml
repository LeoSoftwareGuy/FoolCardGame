<label id="nameLabel"></label>
<div id="loginBlock">
    <input type="text" id="nameInput" placeholder="Name" />
    <button class="btn btn-info" onclick="login()">Lets Play</button>
</div>
<button class="btn btn-danger" id="logoutBtn" onclick="logout()">Logout</button>


<div id="main" class="hidden">
    <button class="btn btn-success createTableBtn" onclick="createTable()">Create Table</button>

    <div id="playingCardsContainer">
        <div id="playingCards">
        </div>
        <button id="makeMoveBtn" class="btn btn-light hidden" onclick="makeAMove()">Make A Move</button>
    </div>

    <div id="table">
        <div id="deck"></div>
        <div id="field"></div>
    </div>
</div>


<div class="hidden">
    <div class="playingCard">
        <div class="playingCard-info">
            <label class="playingCard-info__rank">6</label>
            <label class="playingCard-info__suit">♦</label>
        </div>
    </div>
    <div class="deck-card__shirt">
        <label class="deck-card__number"></label>
    </div>
</div>

<script>
    var user = {};
    var gameStatus = null;
    var authCookieName = 'auth_cookie';
    var authCookieSecret = 'auth_secret';
    init(); // perhaps dont need it here

    function init() {
        let cookieName = getCookie(authCookieName);
        let cookieSecret = getCookie(authCookieSecret);

        if (cookieName == null || cookieSecret == null) {
            document.getElementById('main').classList.add('hidden');
            document.getElementById('nameLabel').classList.add('hidden');
            document.getElementById('logoutBtn').classList.add('hidden');
            document.getElementById('loginBlock').classList.remove('hidden');

        } else {
            user.name = cookieName;
            user.secret = cookieSecret;
            document.getElementById('loginBlock').classList.add('hidden');
            document.getElementById('nameLabel').classList.remove('hidden');
            document.getElementById('logoutBtn').classList.remove('hidden');
            document.getElementById('main').classList.remove('hidden');
            getStatus();
        }

        if (user.name) {
            document.getElementById('nameLabel').innerHTML = user.name;
        }
        else {
            document.getElementById('nameLabel').innerHTML = '';
        }
    }

    // You create 2 cookies when you login
    function login() {
        let name = document.getElementById('nameInput').value;
        let secret = generateGuid();

        setCookie(authCookieName, name, 1);
        setCookie(authCookieSecret, secret, 1)
        init();
    }

    // You delete 2 cookies when you logout
    function logout() {
        deleteCookie(authCookieName);
        deleteCookie(authCookieSecret);
        init();
    }

    function deleteCookie(name) {
        document.cookie = name + '=; Path=/; Expires=Thu, 01 Jan 1970 00:00:01 GMT;';
    }
    function setCookie(name, value, days) {
        var expires = "";
        if (days) {
            var date = new Date();
            date.setTime(date.getTime() + (days * 24 * 60 * 60 * 1000));
            expires = "; expires=" + date.toUTCString();
        } else if (days === 0) {
            expires = "; expires=Thu, 01 Jan 1970 00:00:00 UTC"; // Set to a date in the past
        }
        document.cookie = name + "=" + (value || "") + expires + "; path=/";
    }

    function getCookie(name) {
        var nameEQ = name + "=";
        var ca = document.cookie.split(';');
        for (var i = 0; i < ca.length; i++) {
            var c = ca[i];
            while (c.charAt(0) == ' ') c = c.substring(1, c.length);
            if (c.indexOf(nameEQ) == 0) return c.substring(nameEQ.length, c.length);
        }
        return null;
    }

    function generateGuid() {
        return "10000000-1000-4000-8000-100000000000".replace(/[018]/g, c =>
            (+c ^ crypto.getRandomValues(new Uint8Array(1))[0] & 15 >> +c / 4).toString(16)
        );
    }


    function createTable() {
        SendRequest({
            method: 'POST',
            url: '/Home/CreateTable',
            body: {},
            success: function (data) {
                let tableId = JSON.parse(data.responseText);
                sitToTheTable(tableId);
            },
            error: function (data) {
                alert("Something went wrong during creating of table")
            }
        });
    }

    // passing params as if its GET method, bad approach but for some reason POST does not work.
    function sitToTheTable(tableId) {
        let url = `/Home/JoinTable?playerSecret=${encodeURIComponent(user.secret)}&playerName=${encodeURIComponent(user.name)}&tableGuid=${encodeURIComponent(tableId)}`;
        SendRequest({
            method: 'POST',
            url: url,
            body: {
            },
            success: function (data) {
                getStatus()
            },
            error: function (data) {
                alert("Something went wrong during creating of table")
            }
        });
    }


    function getStatus() {
        SendRequest({
            method: 'GET',
            url: '/Home/GetStatus?playerSecret=' + user.secret,
            success: function (data) {
                let status = JSON.parse(data.responseText);
                gameStatus = status;
                if (status.table == null) {
                    // we need to draw available tables for the user to sit at
                } else {
                    // clear hand, deck and trump cards to refresh the state
                    document.getElementById('playingCards').innerHTML = '';
                    document.getElementById('deck').innerHTML = '';

                    for (let cardIndex = 0; cardIndex < status.table.playerHand.length; cardIndex++) {
                        let card = status.table.playerHand[cardIndex];
                        let cardDiv = document.getElementsByClassName('playingCard')[0].cloneNode(true);

                        // Add event listener to the card div
                        cardDiv.addEventListener('click', function (event) {
                            // Toggle the active class on the card div itself, not the label
                            if (this.classList.contains('active')) {
                                this.classList.remove('active');
                            } else {
                                this.classList.add('active');
                            }
                            checkMoves();
                        });

                        cardDiv.getElementsByClassName('playingCard-info__rank')[0].innerHTML = getRank(card.rank, card.suit);
                        cardDiv.getElementsByClassName('playingCard-info__suit')[0].innerHTML = getSuit(card.suit);

                        document.getElementById('playingCards').appendChild(cardDiv);
                    }

                    if (status.table.trump != null) {
                        let trumpCard = status.table.trump;
                        let trumpCardDiv = document.getElementsByClassName('playingCard')[0].cloneNode(true);

                        trumpCardDiv.getElementsByClassName('playingCard-info__rank')[0].innerHTML = getRank(trumpCard.rank);
                        trumpCardDiv.getElementsByClassName('playingCard-info__suit')[0].innerHTML = getSuit(trumpCard.suit);
                        document.getElementById('deck').appendChild(trumpCardDiv);
                    }

                    if (status.table.deckCardsCount > 1) {
                        let cardDiv = document.getElementsByClassName('deck-card__shirt')[0].cloneNode(true);
                        cardDiv.getElementsByClassName('deck-card__number')[0].innerHTML = status.table.deckCardsCount;
                        document.getElementById('deck').appendChild(cardDiv);
                    }
                }
            },
            error: function (data) {
                alert("Something went wrong during creating of table")
            }
        });
    }

    function checkMoves() {
        let selectedCard = document.querySelectorAll('.playingCard.active');
        if (selectedCard.length > 0) {
            document.getElementById('makeMoveBtn').classList.remove('hidden');
        } else {
            document.getElementById('makeMoveBtn').classList.add('hidden');
        }
    }

    function makeAMove() {
        let selectedCards = document.querySelectorAll('.playingCard.active');
        let cardIndexes = [];
        debugger;
        if (selectedCards.length > 0) {
            let cards = document.querySelectorAll('#playingCards .playingCard');
            for (let i = 0; i < cards.length; i++) {
                if (cards[i].classList.contains('active')) {
                    cardIndexes.push(i);
                }
            }
            let encodedCardIds = cardIndexes.map(id => encodeURIComponent(id)).join(',');
            let url = `/Home/Attack?playerSecret=${encodeURIComponent(user.secret)}&playerName=${encodeURIComponent(user.name)}&cardIds=${[encodedCardIds]}`;
            SendRequest({
                method: 'POST',
                url: url,
                body: {},
                success: function (data) {
                    getStatus();
                },
                error: function (data) {
                    alert("Attack method did not work")
                }
            });
        }
    }

    function getRank(value, suitChar) {
        if (suitChar === '♦' || suitChar === '♥') {
            return "<label style='color:red'>" + value + "</label>";
        } else {
            return value;
        }
    }

    function getSuit(suitChar) {
        if (suitChar === '♦' || suitChar === '♥') {
            return "<label style='color:red'>" + suitChar + "</label>";
        } else {
            return suitChar;
        }
    }



</script>
<style>
    /* CSS for the hidden class */
    .hidden {
        display: none !important;
    }

    #main {
        margin-top: 1rem;
        width: 100%;
    }

    .createTableBtn {
    }

    #table {
        margin-top: 1rem;
        display: flex;
        justify-content: center;
        align-items: center;
    }

    #deck {
        margin-top: 5rem;
        position: relative;
    }

    #makeMoveBtn {
        margin-top: 1rem;
    }

    #playingCardsContainer {
        margin-top: 3rem;
        width: 100%;
        display: flex;
        flex-direction: column;
        align-items: center;
    }

    #playingCards {
        margin-bottom: 1rem;
        display: flex;
        justify-content: center;
        align-items: center;
        column-gap: 0.2rem;
    }

    .playingCard {
        width: 3rem;
        height: 6rem;
        border: 1px solid rgba(0,0,0,.125);
        background-color: #fff;
        border-radius: .25rem;
    }

        .playingCard.active {
            width: 3.5rem; /* Increase width */
            height: 7rem; /* Increase height */
            border-color: rgba(0,0,0,.5); /* Darker border */
            background-color: #f0f0f0; /* Slightly different background color */
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.3); /* Add shadow */
        }

    .playingCard-info {
        margin-left: .2rem;
        width: 100%;
        max-height: 1rem;
        display: flex;
        flex-direction: column;
        column-gap: .01rem;
    }

    .playingCard-info__rank {
        display: block;
        font-size: 1.0rem;
        font-weight: 500;
    }

    .playingCard-info__suit {
        display: block;
        font-size: 3.2rem;
        font-weight: 500;
    }



    .deck-card__shirt {
        position: absolute;
        bottom: -18px;
        left: -30px;
        width: 6rem;
        height: 3rem;
        border: 1px solid rgba(0,0,0,.125);
        background: repeating-linear-gradient( 45deg, #606dbc, #606dbc 10px, #465298 10px, #465298 20px);
        border-radius: .25rem;
    }

    .deck-card__number {
        margin: auto;
        width: 100%;
        color: white;
        font-weight: 500;
        font-size: 1.2rem;
        text-align: center;
    }

</style>